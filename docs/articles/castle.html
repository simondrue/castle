<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to CASTLE • castle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to CASTLE">
<meta property="og:description" content="castle">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">castle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/castle.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/simondrue/castle/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="castle_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to CASTLE</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/simondrue/castle/blob/master/vignettes/castle.Rmd"><code>vignettes/castle.Rmd</code></a></small>
      <div class="hidden name"><code>castle.Rmd</code></div>

    </div>

    
    
<p>In this section we will go through a typical analysis workflow using the <code>castle</code> package:</p>
<ol style="list-style-type: decimal">
<li>How to load a set of droplet counts from a QuantaSoft dataset. For this the data needs to be in <code>.csv</code>-format.</li>
<li>Training a model for the CASTLE algorithm. This is done by analyzing the (assay) specific pattern of errors in a set of negative (background) samples.</li>
<li>Analyze some samples of interest for the presence of a mutation, by utilizing the CASTLE algorithm with the model trained above.</li>
</ol>
<p>The first thing we need to do is load the packages we need for the analysis:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/simondrue/castle">castle</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: readr</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span></code></pre></div>
<div id="loading-quantasoft-data" class="section level3">
<h3 class="hasAnchor">
<a href="#loading-quantasoft-data" class="anchor"></a>Loading QuantaSoft data</h3>
<p>We start by loading a QuantaSoft dataset in <code>.csv</code>-format using the included <code>import_QS_files</code>-function. Here we will use the example data included in the package, where we have both negative samples of different concentrations (training samples) and some test samples available for a KRAS G12D assay. For this assay Ch1 was used for measuring the mutant signal, which is set using the flag <code>Ch1_is_mutation = TRUE</code>. If Ch2 was used this is simply set to <code>FALSE</code>. Data is loaded like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path_to_my_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"path/to/a/csv_file"</span>, <span class="st">"path/to/a/folder/with/csv_files/"</span><span class="op">)</span>
<span class="va">my_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_QS_files.html">import_QS_files</a></span><span class="op">(</span><span class="va">path_to_my_data</span><span class="op">)</span></code></pre></div>
<p>For this example we will load the training samples that are bundled in the <code>castle</code>-package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path_to_my_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/example_data/"</span>, <span class="st">"background_data_KRAS_G12D.csv"</span>, package <span class="op">=</span> <span class="st">"castle"</span><span class="op">)</span>
<span class="va">background_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_QS_files.html">import_QS_files</a></span><span class="op">(</span><span class="va">path_to_my_data</span>, Ch1_is_mutation <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The first 5 samples/wells in <code>background_samples</code> looks like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">background_samples</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 × 13</span>
<span class="co">#&gt;   FileName    Sample  Well  Ch1TargetType Ch2TargetType Target  DoubleNegativeD…</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;         &lt;chr&gt;         &lt;chr&gt;              &lt;dbl&gt;</span>
<span class="co">#&gt; 1 background… NC20_1… A01   Unknown       Unknown       KRAS_G…             2415</span>
<span class="co">#&gt; 2 background… NC21_1… B01   Unknown       Unknown       KRAS_G…             1534</span>
<span class="co">#&gt; 3 background… NC22_1… C01   Unknown       Unknown       KRAS_G…             2041</span>
<span class="co">#&gt; 4 background… NC23_1… D01   Unknown       Unknown       KRAS_G…              183</span>
<span class="co">#&gt; 5 background… NC24_1… E01   Unknown       Unknown       KRAS_G…             1487</span>
<span class="co">#&gt; # … with 6 more variables: WildtypeOnlyDroplets &lt;dbl&gt;,</span>
<span class="co">#&gt; #   MutantOnlyDroplets &lt;dbl&gt;, DoublePositiveDroplets &lt;dbl&gt;,</span>
<span class="co">#&gt; #   TotalDroplets &lt;dbl&gt;, NumberOfMergedWells &lt;dbl&gt;, MergedWells &lt;lgl&gt;</span></code></pre></div>
<p>Note that besides some metadata (file name, target etc.) for each sample, the dataset contains the columns “WildtypeOnlyDroplets”, “MutantOnlyDroplets”, “DoubleNegativeDroplets” and “DoublePositiveDroplets”. These are the counts of the four different kinds of droplets for each sample based on the two signals in Ch1 and Ch2. The following model training and statistical tests are based solely on these counts.</p>
</div>
<div id="training-a-model-for-castle" class="section level3">
<h3 class="hasAnchor">
<a href="#training-a-model-for-castle" class="anchor"></a>Training a model for CASTLE</h3>
<p>To train the model we are only interested in the negative samples. Ideally these should cover the range of different concentrations of DNA that the trained model is expected to encounter in future test samples. Before training we start by removing the empty samples (“NTC”) and positive controls from the training dataset we loaded above:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Remove control samples ("NTC" and "Positive Control")</span>
<span class="va">clean_background_samples</span> <span class="op">&lt;-</span>
  <span class="va">background_samples</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="op">(</span><span class="va">Ch1TargetType</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NTC"</span>, <span class="st">"Positive Control"</span><span class="op">)</span><span class="op">)</span>,
    <span class="op">!</span><span class="op">(</span><span class="va">Ch2TargetType</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NTC"</span>, <span class="st">"Positive Control"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>The cleaned data is then used for model training using the function <code>train_simple_ddpcr_model</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trained_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/train_integrated_ddpcr_model.html">train_integrated_ddpcr_model</a></span><span class="op">(</span>
  background_samples <span class="op">=</span> <span class="va">clean_background_samples</span>
<span class="op">)</span></code></pre></div>
<p>The object <code>trained_model</code> is simply a list of parameters used in the statistical model in CASTLE.</p>
</div>
<div id="testing-some-samples-with-castle" class="section level3">
<h3 class="hasAnchor">
<a href="#testing-some-samples-with-castle" class="anchor"></a>Testing some samples with CASTLE</h3>
<p>For testing we will use a variety of samples from two different patients, who have undergone curative surgery for colorectal cancer. We start by loading the data from these patients. To load the data we will again use the function <code>import_QS_files</code>. But this time, data from some of the samples is distributed across multiple wells. These can be merged together using the flag <code>merge_wells = 'yes'</code> (see <code><a href="../reference/import_QS_files.html">?import_QS_files</a></code> for other methods for merging). Furthermore samples across multiple files can also be merged using the flag <code>merge_files = TRUE</code> if necessary.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Path to example data in the package</span>
<span class="va">path_to_my_test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>
  <span class="st">"extdata/example_data/test_samples"</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"patient_1_plasma_KRAS_G12D.csv"</span>,
    <span class="st">"patient_2_plasma_KRAS_G12D.csv"</span>
  <span class="op">)</span>,
  package <span class="op">=</span> <span class="st">"castle"</span>
<span class="op">)</span>

<span class="co"># Import test examples</span>
<span class="va">test_samples</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/import_QS_files.html">import_QS_files</a></span><span class="op">(</span>
    <span class="va">path_to_my_test_samples</span>,
    merge_wells <span class="op">=</span> <span class="st">"yes"</span>
  <span class="op">)</span></code></pre></div>
<p>To test the samples we use the function <code>test_tumor_sample_integrated</code> and use the model we trained above:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make calls using CASTLE</span>
<span class="va">test_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/test_tumor_sample_integrated.html">test_tumor_sample_integrated</a></span><span class="op">(</span>
  test_samples <span class="op">=</span> <span class="va">test_samples</span>,
  integrated_model <span class="op">=</span> <span class="va">trained_model</span>
<span class="op">)</span></code></pre></div>
<p>We will start by looking at some of the results for the tumor and PBL (white blood cells) sample from each patient:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tumor"</span>, <span class="st">"PBL"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FileName</span>, <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4 × 4</span>
<span class="co">#&gt;   FileName                       Sample p_val mutation_detected</span>
<span class="co">#&gt;   &lt;chr&gt;                          &lt;chr&gt;  &lt;dbl&gt; &lt;lgl&gt;            </span>
<span class="co">#&gt; 1 patient_1_plasma_KRAS_G12D.csv Tumor  0     TRUE             </span>
<span class="co">#&gt; 2 patient_1_plasma_KRAS_G12D.csv PBL    1     FALSE            </span>
<span class="co">#&gt; 3 patient_2_plasma_KRAS_G12D.csv Tumor  0     TRUE             </span>
<span class="co">#&gt; 4 patient_2_plasma_KRAS_G12D.csv PBL    0.455 FALSE</span></code></pre></div>
<p>From this, we clearly see that the mutation is present in the tumor from both of the patients and not in PBL. We can therefore use the mutation as a cancer-specific marker, and thus to check if the patient has residual disease after curative intent surgery. As a positive test, we start by looking at the “Plasma_A” sample of both patients, which is a blood sample collected before surgery:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_A"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FileName</span>, <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 4</span>
<span class="co">#&gt;   FileName                       Sample   p_val mutation_detected</span>
<span class="co">#&gt;   &lt;chr&gt;                          &lt;chr&gt;    &lt;dbl&gt; &lt;lgl&gt;            </span>
<span class="co">#&gt; 1 patient_1_plasma_KRAS_G12D.csv Plasma_A     0 TRUE             </span>
<span class="co">#&gt; 2 patient_2_plasma_KRAS_G12D.csv Plasma_A     0 TRUE</span></code></pre></div>
<p>We see that these samples indicate that the mutation, and thus the tumor, is present in both patients, as expected. From the result we can also see the following estimates of properties of the ddPCR analysis and the ctDNA in the blood:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_A"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">FileName</span>, <span class="va">Sample</span>,
    <span class="va">mutant_molecules_per_droplet</span>,
    <span class="va">wildtype_molecules_per_droplet</span>,
    <span class="va">total_mutant_molecules</span>,
    <span class="va">mutant_molecules_per_droplet_CI_lower</span>, <span class="va">mutant_molecules_per_droplet_CI_upper</span>,
    <span class="va">wildtype_molecules_per_droplet_CI_lower</span>, <span class="va">wildtype_molecules_per_droplet_CI_upper</span>
  <span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 9</span>
<span class="co">#&gt;   FileName      Sample  mutant_molecules_… wildtype_molecules… total_mutant_mol…</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;chr&gt;                &lt;dbl&gt;               &lt;dbl&gt;             &lt;dbl&gt;</span>
<span class="co">#&gt; 1 patient_1_pl… Plasma…           0.000242              0.224               21.3</span>
<span class="co">#&gt; 2 patient_2_pl… Plasma…           0.00386               0.0960             376. </span>
<span class="co">#&gt; # … with 4 more variables: mutant_molecules_per_droplet_CI_lower &lt;dbl&gt;,</span>
<span class="co">#&gt; #   mutant_molecules_per_droplet_CI_upper &lt;dbl&gt;,</span>
<span class="co">#&gt; #   wildtype_molecules_per_droplet_CI_lower &lt;dbl&gt;,</span>
<span class="co">#&gt; #   wildtype_molecules_per_droplet_CI_upper &lt;dbl&gt;</span>

<span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_A"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">FileName</span>, <span class="va">Sample</span>,
    <span class="va">allele_frequency</span>,
    <span class="va">allele_frequency_CI_lower</span>, <span class="va">allele_frequency_CI_upper</span>
  <span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt;   FileName        Sample  allele_frequency allele_frequency_… allele_frequency_…</span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt;              &lt;dbl&gt;              &lt;dbl&gt;              &lt;dbl&gt;</span>
<span class="co">#&gt; 1 patient_1_plas… Plasma…          0.00108           0.000576            0.00181</span>
<span class="co">#&gt; 2 patient_2_plas… Plasma…          0.0387            0.0339              0.0438</span></code></pre></div>
<p>We can then look what happens after the surgery. To do this we look at the blood samples marked as “Plasma_B”:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_B"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FileName</span>, <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 4</span>
<span class="co">#&gt;   FileName                       Sample   p_val mutation_detected</span>
<span class="co">#&gt;   &lt;chr&gt;                          &lt;chr&gt;    &lt;dbl&gt; &lt;lgl&gt;            </span>
<span class="co">#&gt; 1 patient_1_plasma_KRAS_G12D.csv Plasma_B 0.306 FALSE            </span>
<span class="co">#&gt; 2 patient_2_plasma_KRAS_G12D.csv Plasma_B 0.242 FALSE</span></code></pre></div>
<p>We now see that the test indicates that the mutation is no longer present in any of the patients, which is consistent with the tumor being removed by surgery.</p>
<p>The full list of information available in the analysis results is:</p>
<pre><code>#&gt;  [1] "FileName"                               
#&gt;  [2] "Sample"                                 
#&gt;  [3] "Well"                                   
#&gt;  [4] "Ch1TargetType"                          
#&gt;  [5] "Ch2TargetType"                          
#&gt;  [6] "Target"                                 
#&gt;  [7] "DoubleNegativeDroplets"                 
#&gt;  [8] "WildtypeOnlyDroplets"                   
#&gt;  [9] "MutantOnlyDroplets"                     
#&gt; [10] "DoublePositiveDroplets"                 
#&gt; [11] "TotalDroplets"                          
#&gt; [12] "NumberOfMergedWells"                    
#&gt; [13] "MergedWells"                            
#&gt; [14] "mutant_molecules_per_droplet"           
#&gt; [15] "wildtype_molecules_per_droplet"         
#&gt; [16] "p_val"                                  
#&gt; [17] "test_statistic"                         
#&gt; [18] "mutation_detected"                      
#&gt; [19] "allele_frequency"                       
#&gt; [20] "total_mutant_molecules"                 
#&gt; [21] "total_wildtype_molecules"               
#&gt; [22] "mutant_molecules_per_droplet_CI_lower"  
#&gt; [23] "mutant_molecules_per_droplet_CI_upper"  
#&gt; [24] "allele_frequency_CI_lower"              
#&gt; [25] "allele_frequency_CI_upper"              
#&gt; [26] "total_mutant_molecules_CI_lower"        
#&gt; [27] "total_mutant_molecules_CI_upper"        
#&gt; [28] "wildtype_molecules_per_droplet_CI_lower"
#&gt; [29] "wildtype_molecules_per_droplet_CI_upper"</code></pre>
<p>The results can be exported to <code>.csv</code> format via the function <code>write_csv(x = test_res, file = "your/file/path)</code>.</p>
</div>
<div id="note" class="section level3">
<h3 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h3>
<p>Alternatively the functions <code>train_integrated_ddpcr_model</code> and <code>test_tumor_sample_simple</code> are used for training and testing respectively. These are based on a faster (and simpler) version of the CASTLE algorithm, but have very similar performance. See [1] for more information.</p>
</div>
<div id="simulating-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-data" class="anchor"></a>Simulating data</h2>
<p>In the package the function <code>simulate_droplet_counts</code> for simulating droplet counts from the statistical model that CASTLE is based on is also provided. Here we will simulate a positive and negative sample based on the parameters learned above, and test them using <code>test_tumor_sample_integrated</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># DNA concentration (molecules per droplet)</span>
<span class="va">l</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># WT</span>
<span class="va">r_positive</span> <span class="op">&lt;-</span> <span class="fl">0.01</span> <span class="co"># M</span>
<span class="va">r_negative</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># M</span>

<span class="co"># Number of droplets</span>
<span class="va">n_drops</span> <span class="op">&lt;-</span> <span class="fl">14000</span>

<span class="co"># Positive sample</span>
<span class="va">test_sample_positive</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/simulate_droplet_counts.html">simulate_droplet_counts</a></span><span class="op">(</span>
    l <span class="op">=</span> <span class="va">l</span>, r <span class="op">=</span> <span class="va">r_positive</span>,
    a <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">a_est</span>, b <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">b_est</span>, c <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">c_est</span>,
    n_drops <span class="op">=</span> <span class="va">n_drops</span>
  <span class="op">)</span>

<span class="co"># Negative sample</span>
<span class="va">test_sample_negative</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/simulate_droplet_counts.html">simulate_droplet_counts</a></span><span class="op">(</span>
    l <span class="op">=</span> <span class="va">l</span>, r <span class="op">=</span> <span class="va">r_negative</span>,
    a <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">a_est</span>, b <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">b_est</span>, c <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">c_est</span>,
    n_drops <span class="op">=</span> <span class="va">n_drops</span>
  <span class="op">)</span>


<span class="va">simulated_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Sample <span class="op">=</span> <span class="st">"Positive"</span>, <span class="va">test_sample_positive</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Sample <span class="op">=</span> <span class="st">"Negative"</span>, <span class="va">test_sample_negative</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># Test samples</span>
<span class="va">sim_test_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/test_tumor_sample_simple.html">test_tumor_sample_simple</a></span><span class="op">(</span>
  test_samples <span class="op">=</span> <span class="va">simulated_samples</span>,
  simple_model <span class="op">=</span> <span class="va">trained_model</span>
<span class="op">)</span>

<span class="co"># Print some relevant results</span>
<span class="va">sim_test_res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
  <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span>,
  <span class="va">total_mutant_molecules</span>, <span class="va">total_mutant_molecules_CI_lower</span>, <span class="va">total_mutant_molecules_CI_upper</span>
<span class="op">)</span>
<span class="co">#&gt;     Sample p_val mutation_detected total_mutant_molecules</span>
<span class="co">#&gt; 1 Positive     0              TRUE               117.0746</span>
<span class="co">#&gt; 2 Negative     1             FALSE                 0.0000</span>
<span class="co">#&gt;   total_mutant_molecules_CI_lower total_mutant_molecules_CI_upper</span>
<span class="co">#&gt; 1                        91.27136                      147.317087</span>
<span class="co">#&gt; 2                         0.00000                        5.092378</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Simon Drue.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
