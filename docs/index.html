<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortify your ddPCR analyses for low-frequency variant detection • castle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Fortify your ddPCR analyses for low-frequency variant detection">
<meta property="og:description" content="This package is a user friendly implementation of the CASTLE (**C**oncentration and **A**ssay **S**pecific **T**umor **L**oad **E**stimator) algorithm, as it is described in [1]. Using the right analysis tool for your ddPCR analysis results when detecting low frequency variants can mean night and day for the performance of your pipeline. In this package functions for training a model and testing samples for low frequency variants are provided, as well as functionality to handle output .csv-files generated by QuantaSoft from Bio-Rad Laboratories Inc.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">castle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="articles/castle.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/simondrue/castle/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="welcome-to-the-castle" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#welcome-to-the-castle" class="anchor"></a>Welcome to the CASTLE</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>This package is a user friendly implementation of the CASTLE (<strong>C</strong>oncentration and <strong>A</strong>ssay <strong>S</strong>pecific <strong>T</strong>umor <strong>L</strong>oad <strong>E</strong>stimator) algorithm, as it is described in <span class="math display">1</span>. Using the right analysis tool for your ddPCR analysis results when detecting low frequency variants can mean night and day for the performance of your pipeline. In this package functions for training a model and testing samples for low frequency variants are provided, as well as functionality to handle output .csv-files generated by QuantaSoft from Bio-Rad Laboratories Inc. </p>
<p><span class="math display">1</span>: <span class="math display"><em>a</em><em>r</em><em>t</em><em>i</em><em>c</em><em>l</em><em>e</em></span>.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the R -package from <a href="https://github.com/simondrue/castle/">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"simondrue/castle"</span><span class="op">)</span></code></pre></div>
</div>
<div id="quickstart-guide" class="section level2">
<h2 class="hasAnchor">
<a href="#quickstart-guide" class="anchor"></a>Quickstart guide</h2>
<p>In this section we will go through a typical analysis workflow using the <code>castle</code> package:</p>
<ol>
<li>How to load a set of droplet counts from a QuantaSoft dataset. For this the data needs to be in <code>.csv</code>-format.</li>
<li>Training a model for the CASTLE algorithm. This is done by analyzing the (assay) specific pattern of errors in a set of negative (background) samples.</li>
<li>Analyze some samples of interest for the presence of a mutation, by utilizing the CASTLE algorithm with the model trained above.</li>
</ol>
<p>The first thing we need to do is load the packages we need for the analysis:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/simondrue/castle">castle</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: readr</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span></code></pre></div>
<div id="loading-quantasoft-data" class="section level3">
<h3 class="hasAnchor">
<a href="#loading-quantasoft-data" class="anchor"></a>Loading QuantaSoft data</h3>
<p>We start by loading a QuantaSoft dataset in <code>.csv</code>-format using the included <code>import_QS_files</code>-function. Here we will use the example data included in the package, where we have both negative samples of different concentrations (training samples) and some test samples available for a KRAS G12D assay. For this assay Ch1 was used for measuring the mutant signal, which is set using the flag <code>Ch1_is_mutation = TRUE</code>. If Ch2 was used this is simply set to <code>FALSE</code>. Data is loaded like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path_to_my_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"path/to/a/csv_file"</span>, <span class="st">"path/to/a/folder/with/csv_files/"</span><span class="op">)</span>
<span class="va">my_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/import_QS_files.html">import_QS_files</a></span><span class="op">(</span><span class="va">path_to_my_data</span><span class="op">)</span></code></pre></div>
<p>For this example we will load the training samples that are bundled in the <code>castle</code>-package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path_to_my_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/example_data/"</span>, <span class="st">"background_data_KRAS_G12D.csv"</span>, package <span class="op">=</span> <span class="st">"castle"</span><span class="op">)</span>
<span class="va">background_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/import_QS_files.html">import_QS_files</a></span><span class="op">(</span><span class="va">path_to_my_data</span>, Ch1_is_mutation <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The first 5 samples/wells in <code>background_samples</code> looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">background_samples</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="14%">
<col width="4%">
<col width="2%">
<col width="6%">
<col width="6%">
<col width="7%">
<col width="10%">
<col width="9%">
<col width="8%">
<col width="10%">
<col width="6%">
<col width="8%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">FileName</th>
<th align="left">Sample</th>
<th align="left">Well</th>
<th align="left">Ch1TargetType</th>
<th align="left">Ch2TargetType</th>
<th align="left">Target</th>
<th align="right">DoubleNegativeDroplets</th>
<th align="right">WildtypeOnlyDroplets</th>
<th align="right">MutantOnlyDroplets</th>
<th align="right">DoublePositiveDroplets</th>
<th align="right">TotalDroplets</th>
<th align="right">NumberOfMergedWells</th>
<th align="left">MergedWells</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">background_data_KRAS_G12D.csv</td>
<td align="left">NC20_150</td>
<td align="left">A01</td>
<td align="left">Unknown</td>
<td align="left">Unknown</td>
<td align="left">KRAS_G12D_(FAM)</td>
<td align="right">2415</td>
<td align="right">11005</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">13420</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">background_data_KRAS_G12D.csv</td>
<td align="left">NC21_150</td>
<td align="left">B01</td>
<td align="left">Unknown</td>
<td align="left">Unknown</td>
<td align="left">KRAS_G12D_(FAM)</td>
<td align="right">1534</td>
<td align="right">8336</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">9870</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">background_data_KRAS_G12D.csv</td>
<td align="left">NC22_150</td>
<td align="left">C01</td>
<td align="left">Unknown</td>
<td align="left">Unknown</td>
<td align="left">KRAS_G12D_(FAM)</td>
<td align="right">2041</td>
<td align="right">9563</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">11605</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">background_data_KRAS_G12D.csv</td>
<td align="left">NC23_150</td>
<td align="left">D01</td>
<td align="left">Unknown</td>
<td align="left">Unknown</td>
<td align="left">KRAS_G12D_(FAM)</td>
<td align="right">183</td>
<td align="right">13180</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">13363</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">background_data_KRAS_G12D.csv</td>
<td align="left">NC24_150</td>
<td align="left">E01</td>
<td align="left">Unknown</td>
<td align="left">Unknown</td>
<td align="left">KRAS_G12D_(FAM)</td>
<td align="right">1487</td>
<td align="right">9421</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">10908</td>
<td align="right">1</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>Note that besides some metadata (file name, target etc.) for each sample, the dataset contains the columns “WildtypeOnlyDroplets”, “MutantOnlyDroplets”, “DoubleNegativeDroplets” and “DoublePositiveDroplets”. These are the counts of the four different kinds of droplets for each sample based on the two signals in Ch1 and Ch2. The following model training and statistical tests are based solely on these counts.</p>
</div>
<div id="training-a-model-for-castle" class="section level3">
<h3 class="hasAnchor">
<a href="#training-a-model-for-castle" class="anchor"></a>Training a model for CASTLE</h3>
<p>To train the model we are only interested in the negative samples. Ideally these should cover the range of different concentrations of DNA that the trained model is expected to encounter in future test samples. Before training we start by removing the empty samples (“NTC”) and positive controls from the training dataset we loaded above:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Remove control samples ("NTC" and "Positive Control")</span>
<span class="va">clean_background_samples</span> <span class="op">&lt;-</span>
  <span class="va">background_samples</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="op">(</span><span class="va">Ch1TargetType</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NTC"</span>, <span class="st">"Positive Control"</span><span class="op">)</span><span class="op">)</span>,
    <span class="op">!</span><span class="op">(</span><span class="va">Ch2TargetType</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NTC"</span>, <span class="st">"Positive Control"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>The cleaned data is then used for model training using the function <code>train_simple_ddpcr_model</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trained_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/train_integrated_ddpcr_model.html">train_integrated_ddpcr_model</a></span><span class="op">(</span>
  background_samples <span class="op">=</span> <span class="va">clean_background_samples</span>
<span class="op">)</span></code></pre></div>
<p>The object <code>trained_model</code> is simply a list of parameters used in the statistical model in CASTLE.</p>
</div>
<div id="testing-some-samples-with-castle" class="section level3">
<h3 class="hasAnchor">
<a href="#testing-some-samples-with-castle" class="anchor"></a>Testing some samples with CASTLE</h3>
<p>For testing we will use a variety of samples from two different patients, who have undergone curative surgery for colorectal cancer. We start by loading the data from these patients. To load the data we will again use the function <code>import_QS_files</code>. But this time, data from some of the samples is distributed across multiple wells. These can be merged together using the flag <code>merge_wells = 'yes'</code> (see <code><a href="reference/import_QS_files.html">?import_QS_files</a></code> for other methods for merging). Furthermore samples across multiple files can also be merged using the flag <code>merge_files = TRUE</code> if necessary.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Path to example data in the package</span>
<span class="va">path_to_my_test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>
  <span class="st">"extdata/example_data/test_samples"</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"patient_1_plasma_KRAS_G12D.csv"</span>,
    <span class="st">"patient_2_plasma_KRAS_G12D.csv"</span>
  <span class="op">)</span>,
  package <span class="op">=</span> <span class="st">"castle"</span>
<span class="op">)</span>

<span class="co"># Import test examples</span>
<span class="va">test_samples</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/import_QS_files.html">import_QS_files</a></span><span class="op">(</span>
    <span class="va">path_to_my_test_samples</span>,
    merge_wells <span class="op">=</span> <span class="st">"yes"</span>
  <span class="op">)</span></code></pre></div>
<p>To test the samples we use the function <code>test_tumor_sample_integrated</code> and use the model we trained above:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make calls using CASTLE</span>
<span class="va">test_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/test_tumor_sample_integrated.html">test_tumor_sample_integrated</a></span><span class="op">(</span>
  test_samples <span class="op">=</span> <span class="va">test_samples</span>,
  integrated_model <span class="op">=</span> <span class="va">trained_model</span>
<span class="op">)</span></code></pre></div>
<p>We will start by looking at some of the results for the tumor and PBL (white blood cells) sample from each patient:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tumor"</span>, <span class="st">"PBL"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FileName</span>, <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">FileName</th>
<th align="left">Sample</th>
<th align="right">p_val</th>
<th align="left">mutation_detected</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">patient_1_plasma_KRAS_G12D.csv</td>
<td align="left">Tumor</td>
<td align="right">0.0000000</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">patient_1_plasma_KRAS_G12D.csv</td>
<td align="left">PBL</td>
<td align="right">1.0000000</td>
<td align="left">FALSE</td>
</tr>
<tr class="odd">
<td align="left">patient_2_plasma_KRAS_G12D.csv</td>
<td align="left">Tumor</td>
<td align="right">0.0000000</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">patient_2_plasma_KRAS_G12D.csv</td>
<td align="left">PBL</td>
<td align="right">0.4550231</td>
<td align="left">FALSE</td>
</tr>
</tbody>
</table>
<p>From this, we clearly see that the mutation is present in the tumor from both of the patients and not in PBL. We can therefore use the mutation as a cancer-specific marker, and thus to check if the patient has residual disease after curative intent surgery. As a positive test, we start by looking at the “Plasma_A” sample of both patients, which is a blood sample collected before surgery:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_A"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FileName</span>, <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">FileName</th>
<th align="left">Sample</th>
<th align="right">p_val</th>
<th align="left">mutation_detected</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">patient_1_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_A</td>
<td align="right">0</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">patient_2_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_A</td>
<td align="right">0</td>
<td align="left">TRUE</td>
</tr>
</tbody>
</table>
<p>We see that these samples indicate that the mutation, and thus the tumor, is present in both patients, as expected. From the result we can also see the following estimates of properties of the ddPCR analysis and the ctDNA in the blood:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_A"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">FileName</span>, <span class="va">Sample</span>,
    <span class="va">mutant_molecules_per_droplet</span>,
    <span class="va">wildtype_molecules_per_droplet</span>,
    <span class="va">total_mutant_molecules</span>,
    <span class="va">mutant_molecules_per_droplet_CI_lower</span>, <span class="va">mutant_molecules_per_droplet_CI_upper</span>,
    <span class="va">wildtype_molecules_per_droplet_CI_lower</span>, <span class="va">wildtype_molecules_per_droplet_CI_upper</span>
  <span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="11%">
<col width="3%">
<col width="10%">
<col width="10%">
<col width="8%">
<col width="13%">
<col width="13%">
<col width="14%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">FileName</th>
<th align="left">Sample</th>
<th align="right">mutant_molecules_per_droplet</th>
<th align="right">wildtype_molecules_per_droplet</th>
<th align="right">total_mutant_molecules</th>
<th align="right">mutant_molecules_per_droplet_CI_lower</th>
<th align="right">mutant_molecules_per_droplet_CI_upper</th>
<th align="right">wildtype_molecules_per_droplet_CI_lower</th>
<th align="right">wildtype_molecules_per_droplet_CI_upper</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">patient_1_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_A</td>
<td align="right">0.0002420</td>
<td align="right">0.2235039</td>
<td align="right">21.32192</td>
<td align="right">0.0001289</td>
<td align="right">0.0004051</td>
<td align="right">0.2191840</td>
<td align="right">0.2278834</td>
</tr>
<tr class="even">
<td align="left">patient_2_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_A</td>
<td align="right">0.0038629</td>
<td align="right">0.0959883</td>
<td align="right">376.09432</td>
<td align="right">0.0033714</td>
<td align="right">0.0043999</td>
<td align="right">0.0933878</td>
<td align="right">0.0986397</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_A"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">FileName</span>, <span class="va">Sample</span>,
    <span class="va">allele_frequency</span>,
    <span class="va">allele_frequency_CI_lower</span>, <span class="va">allele_frequency_CI_upper</span>
  <span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="28%">
<col width="8%">
<col width="15%">
<col width="23%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th align="left">FileName</th>
<th align="left">Sample</th>
<th align="right">allele_frequency</th>
<th align="right">allele_frequency_CI_lower</th>
<th align="right">allele_frequency_CI_upper</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">patient_1_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_A</td>
<td align="right">0.0010815</td>
<td align="right">0.0005764</td>
<td align="right">0.0018094</td>
</tr>
<tr class="even">
<td align="left">patient_2_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_A</td>
<td align="right">0.0386864</td>
<td align="right">0.0339311</td>
<td align="right">0.0438292</td>
</tr>
</tbody>
</table>
<p>We can then look what happens after the surgery. To do this we look at the blood samples marked as “Plasma_B”:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_res</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Sample</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Plasma_B"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FileName</span>, <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">FileName</th>
<th align="left">Sample</th>
<th align="right">p_val</th>
<th align="left">mutation_detected</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">patient_1_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_B</td>
<td align="right">0.3061083</td>
<td align="left">FALSE</td>
</tr>
<tr class="even">
<td align="left">patient_2_plasma_KRAS_G12D.csv</td>
<td align="left">Plasma_B</td>
<td align="right">0.2424636</td>
<td align="left">FALSE</td>
</tr>
</tbody>
</table>
<p>We now see that the test indicates that the mutation is no longer present in any of the patients, which is consistent with the tumor being removed by surgery.</p>
<p>The full list of information available in the analysis results is:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] "FileName"                               </span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [2] "Sample"                                 </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [3] "Well"                                   </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [4] "Ch1TargetType"                          </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] "Ch2TargetType"                          </span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [6] "Target"                                 </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [7] "DoubleNegativeDroplets"                 </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [8] "WildtypeOnlyDroplets"                   </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] "MutantOnlyDroplets"                     </span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [10] "DoublePositiveDroplets"                 </span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [11] "TotalDroplets"                          </span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [12] "NumberOfMergedWells"                    </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] "MergedWells"                            </span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [14] "mutant_molecules_per_droplet"           </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [15] "wildtype_molecules_per_droplet"         </span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [16] "p_val"                                  </span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [17] "test_statistic"                         </span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [18] "mutation_detected"                      </span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [19] "allele_frequency"                       </span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [20] "total_mutant_molecules"                 </span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [21] "total_wildtype_molecules"               </span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [22] "mutant_molecules_per_droplet_CI_lower"  </span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [23] "mutant_molecules_per_droplet_CI_upper"  </span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [24] "allele_frequency_CI_lower"              </span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [25] "allele_frequency_CI_upper"              </span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [26] "total_mutant_molecules_CI_lower"        </span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [27] "total_mutant_molecules_CI_upper"        </span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [28] "wildtype_molecules_per_droplet_CI_lower"</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [29] "wildtype_molecules_per_droplet_CI_upper"</span></span></code></pre></div>
<p>The results can be exported to <code>.csv</code> format via the function <code>write_csv(x = test_res, file = "your/file/path)</code>.</p>
</div>
</div>
<div id="note" class="section level2">
<h2 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h2>
<p>Alternatively the functions <code>train_integrated_ddpcr_model</code> and <code>test_tumor_sample_simple</code> are used for training and testing respectively. These are based on a faster (and simpler) version of the CASTLE algorithm, but have very similar performance. See <span class="math display">1</span> for more information.</p>
</div>
<div id="simulating-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-data" class="anchor"></a>Simulating data</h2>
<p>In the package the function <code>simulate_droplet_counts</code> for simulating droplet counts from the statistical model that CASTLE is based on is also provided. Here we will simulate a positive and negative sample based on the parameters learned above, and test them using <code>test_tumor_sample_integrated</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># DNA concentration (molecules per droplet)</span>
<span class="va">l</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># WT</span>
<span class="va">r_positive</span> <span class="op">&lt;-</span> <span class="fl">0.01</span> <span class="co"># M</span>
<span class="va">r_negative</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># M</span>

<span class="co"># Number of droplets</span>
<span class="va">n_drops</span> <span class="op">&lt;-</span> <span class="fl">14000</span>

<span class="co"># Positive sample</span>
<span class="va">test_sample_positive</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/simulate_droplet_counts.html">simulate_droplet_counts</a></span><span class="op">(</span>
    l <span class="op">=</span> <span class="va">l</span>, r <span class="op">=</span> <span class="va">r_positive</span>,
    a <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">a_est</span>, b <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">b_est</span>, c <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">c_est</span>,
    n_drops <span class="op">=</span> <span class="va">n_drops</span>
  <span class="op">)</span>

<span class="co"># Negative sample</span>
<span class="va">test_sample_negative</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="reference/simulate_droplet_counts.html">simulate_droplet_counts</a></span><span class="op">(</span>
    l <span class="op">=</span> <span class="va">l</span>, r <span class="op">=</span> <span class="va">r_negative</span>,
    a <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">a_est</span>, b <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">b_est</span>, c <span class="op">=</span> <span class="va">trained_model</span><span class="op">$</span><span class="va">c_est</span>,
    n_drops <span class="op">=</span> <span class="va">n_drops</span>
  <span class="op">)</span>


<span class="va">simulated_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Sample <span class="op">=</span> <span class="st">"Positive"</span>, <span class="va">test_sample_positive</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Sample <span class="op">=</span> <span class="st">"Negative"</span>, <span class="va">test_sample_negative</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># Test samples</span>
<span class="va">sim_test_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/test_tumor_sample_simple.html">test_tumor_sample_simple</a></span><span class="op">(</span>
  test_samples <span class="op">=</span> <span class="va">simulated_samples</span>,
  simple_model <span class="op">=</span> <span class="va">trained_model</span>
<span class="op">)</span>

<span class="co"># Print some relevant results</span>
<span class="va">sim_test_res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
  <span class="va">Sample</span>, <span class="va">p_val</span>, <span class="va">mutation_detected</span>,
  <span class="va">total_mutant_molecules</span>, <span class="va">total_mutant_molecules_CI_lower</span>, <span class="va">total_mutant_molecules_CI_upper</span>
<span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="7%">
<col width="5%">
<col width="14%">
<col width="18%">
<col width="26%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th align="left">Sample</th>
<th align="right">p_val</th>
<th align="left">mutation_detected</th>
<th align="right">total_mutant_molecules</th>
<th align="right">total_mutant_molecules_CI_lower</th>
<th align="right">total_mutant_molecules_CI_upper</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Positive</td>
<td align="right">0</td>
<td align="left">TRUE</td>
<td align="right">134.2272</td>
<td align="right">106.4461</td>
<td align="right">166.450423</td>
</tr>
<tr class="even">
<td align="left">Negative</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">0.0000</td>
<td align="right">0.0000</td>
<td align="right">3.317448</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/simondrue/castle/">https://​github.com/​simondrue/​castle/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/simondrue/castle/issues">https://​github.com/​simondrue/​castle/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Simon Drue <br><small class="roles"> Maintainer, author </small> <a href="https://orcid.org/0000-0002-1401-6527" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Simon Drue.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
